<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Source Tracker</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <div class="container">
    <h2>Source Tracker</h2>

    <form id="detectForm">
      <input type="text" id="textInput" placeholder="Enter text to analyze..." required>

      <div class="date-inputs">
        <div>
          <label for="initialDate">Initial Date:</label>
          <input type="date" id="initialDate" name="initialDate">
        </div>
        <div>
          <label for="finalDate">Final Date:</label>
          <input type="date" id="finalDate" name="finalDate">
        </div>
      </div>

      <div class="mode-selection">
        <div>
          <input type="radio" id="find_source" name="mode" value="find_source" checked>
          <label for="find_source">Find Source</label>
        </div>
        <div>
          <input type="radio" id="find_all" name="mode" value="find_all">
          <label for="find_all">Find All</label>
        </div>
      </div>

      <div class="advanced-settings">
        <button type="button" id="toggleAdvanced" class="toggle-btn">⚙️ Advanced Settings</button>
        <div id="advancedContent" class="advanced-content" hidden>
          <label>
            <input type="checkbox" id="use-synonyms" name="synonyms"> Use Synonyms
          </label>

          <div id="synonym-options" style="display:none;">
            <label for="model_name">Model:</label>
            <select id="model_name" name="model_name">
              <option value="en_core_web_md" selected>en_core_web_md</option>
              <option value="en_core_web_lg">en_core_web_lg</option>
            </select>

            <label for="top_n_syns">Top N Synonyms:</label>
            <input type="number" id="top_n_syns" value="4" min="1" max="10">

            <label for="threshold">Similarity Threshold:</label>
            <input type="number" id="threshold" value="0.1" step="0.05" min="0" max="1">

            <label for="max_syns_per_kw">Max Synonyms per Keyword:</label>
            <input type="number" id="max_syns_per_kw" value="2" min="1" max="10">
          </div>

          <label for="max_keywords">Max Keywords</label>
          <input type="number" id="max_keywords" value="5">

          <label for="n_keywords_dropped">Number of Keywords Dropped</label>
          <input type="number" id="n_keywords_dropped" value="1">

          <label for="earliest_k">Earliest K</label>
          <input type="number" id="earliest_k" value="0">

          <label>Excludes</label>
          <div id="excludes" class="checkbox-group">
            <label><input type="checkbox" value="nativeretweets" checked> nativeretweets</label>
            <label><input type="checkbox" value="media"> media</label>
            <label><input type="checkbox" value="videos"> videos</label>
            <label><input type="checkbox" value="news"> news</label>
            <label><input type="checkbox" value="verified"> verified</label>
            <label><input type="checkbox" value="native_video"> native_video</label>
            <label><input type="checkbox" value="replies" checked> replies</label>
            <label><input type="checkbox" value="links"> links</label>
            <label><input type="checkbox" value="images"> images</label>
            <label><input type="checkbox" value="safe"> safe</label>
            <label><input type="checkbox" value="quote"> quote</label>
            <label><input type="checkbox" value="pro_video"> pro_video</label>
          </div>
        </div>
      </div>

      <button type="submit" id="analyzeBtn">Analyze</button>
    </form>

    <!-- Dynamic synonym section -->
    <div id="synonymSection" style="display:none;">
      <h3>Select Synonyms</h3>
      <div id="synonymList"></div>
      <button id="continueBtn" type="button">Continue</button>
    </div>

    <div id="result" style="display:none;"></div>
  </div>

  <script>
    const resultDiv = document.getElementById('result');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const synonymSection = document.getElementById('synonymSection');
    const synonymList = document.getElementById('synonymList');

    document.getElementById('toggleAdvanced').addEventListener('click', () => {
      document.getElementById('advancedContent').classList.toggle('show');
    });

    document.getElementById('use-synonyms').addEventListener('change', (e) => {
      document.getElementById('synonym-options').style.display = e.target.checked ? 'block' : 'none';
    });

    let cachedParams = {};
    let cachedSynonyms = {};
    let cachedKeywords = null;

    document.getElementById('detectForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      resultDiv.style.display = 'flex';
      resultDiv.innerHTML = '<div class="spinner"></div> Analyzing...';
      analyzeBtn.disabled = true;

      const params = {
        text: document.getElementById('textInput').value,
        initialDate: document.getElementById('initialDate').value || "",
        finalDate: document.getElementById('finalDate').value || "",
        mode: document.querySelector('input[name="mode"]:checked').value,
        max_keywords: parseInt(document.getElementById('max_keywords').value) || 5,
        n_keywords_dropped: parseInt(document.getElementById('n_keywords_dropped').value) || 1,
        excludes: Array.from(document.querySelectorAll('#excludes input:checked')).map(cb => cb.value),
        synonyms: document.getElementById('use-synonyms').checked,
        model_name: document.getElementById('model_name').value,
        top_n_syns: parseInt(document.getElementById('top_n_syns').value),
        threshold: parseFloat(document.getElementById('threshold').value),
        max_syns_per_kw: parseInt(document.getElementById('max_syns_per_kw').value),
        earliest_k: parseInt(document.getElementById('earliest_k').value)
      };

      cachedParams = params;

      try {
        if (params.synonyms) {
          const res = await fetch('http://127.0.0.1:8000/api/synonyms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: params.text,
              model_name: params.model_name,
              top_n_syns: params.top_n_syns,
              threshold: params.threshold
            })
          });
          const data = await res.json();
          cachedSynonyms = data.synonyms;
          cachedKeywords = data.keywords;
          displaySynonymOptions(cachedSynonyms);
        } else {
          await performAnalysis(params);
        }
      } catch (err) {
        resultDiv.textContent = 'Network error.';
      }
    });

    function displaySynonymOptions(synonyms) {
      synonymList.innerHTML = '';
      synonymSection.style.display = 'block';
      resultDiv.style.display = 'none';

      for (const [kw, syns] of Object.entries(synonyms)) {
        const block = document.createElement('div');
        block.classList.add('keyword-block');
        block.innerHTML = `
          <h4>${kw}</h4>
          <div class="synonyms">
            ${syns.map(s => `
              <label><input type="checkbox" name="${kw}" value="${s}"> ${s}</label>
            `).join('')}
            <div class="custom-synonym-list"></div>
          </div>
          <div class="tag-input-wrapper">
            <input type="text" placeholder="Add your own synonym and press Enter">
          </div>
        `;
        synonymList.appendChild(block);

        const input = block.querySelector('input[type="text"]');
        const customList = block.querySelector('.custom-synonym-list');

        // Handle adding/removing tags with animations
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            const val = input.value.trim();
            if (!val) return;
            const tag = document.createElement('div');
            tag.classList.add('custom-synonym-tag', 'tag-appear');
            tag.innerHTML = `${val} <span>&times;</span>`;
            tag.querySelector('span').addEventListener('click', () => {
              tag.classList.add('tag-remove');
              setTimeout(() => tag.remove(), 300);
            });
            customList.appendChild(tag);
            input.value = '';
          } else if (e.key === 'Backspace' && input.value === '') {
            const last = customList.lastElementChild;
            if (last) {
              last.classList.add('tag-remove');
              setTimeout(() => last.remove(), 300);
            }
          }
        });
      }
    }

    document.getElementById('continueBtn').addEventListener('click', async () => {
      const selections = {};
      document.querySelectorAll('.keyword-block').forEach(block => {
        const kw = block.querySelector('h4').textContent;
        const checked = [...block.querySelectorAll('input[type="checkbox"]:checked')].map(i => i.value);
        const custom = [...block.querySelectorAll('.custom-synonym-tag')].map(t => t.textContent.replace('×', '').trim());
        selections[kw] = [kw, ...checked, ...custom];
      });

      cachedParams["selected_synonyms"] = selections;
      cachedParams["keywords"] = cachedKeywords;
      synonymSection.style.display = 'none';
      await performAnalysis(cachedParams);
    });

    async function performAnalysis(params) {
      resultDiv.style.display = 'flex';
      resultDiv.innerHTML = '<div class="spinner"></div> Running analysis...';

      const response = await fetch('http://127.0.0.1:8000/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
      });

      if (response.ok) {
        const result = await response.json();
        // handle display as before...
        resultDiv.textContent = JSON.stringify(result, null, 2);
      } else {
        resultDiv.textContent = 'Error analyzing text.';
      }
      analyzeBtn.disabled = false;
    }
  </script>
</body>
</html>
