<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Climate Disinformation Tracker</title>
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="static/main.css">
  <link rel="stylesheet" href="static/assets/animations.css">
  <link rel="stylesheet" href="static/assets/advanced-settings.css">
  <link rel="stylesheet" href="static/assets/buttons.css">
  <link rel="stylesheet" href="static/assets/info_overlay.css">
  <link rel="stylesheet" href="static/assets/input.css">
  <link rel="stylesheet" href="static/assets/synonyms.css">
  <link rel="stylesheet" href="static/assets/tags.css">
</head>
<body>
  <!-- Info Overlay -->
  <div id="info-overlay">
    <div id="info-content">
      <span id="close-info">&times;</span>
      <h2>Tool Overview</h2>
      <p>
        The Climate Disinformation Tracker traces the earliest online appearance of a (climate) claim on X/Twitter, showing when and by whom it first appeared.
        When retrieving all tweets, it provides a dashboard to visualize how the claim spread and gained engagement over time.
        Here, the <strong>source</strong> refers to the earliest retrievable tweet that semantically matches the claim, not necessarily the true origin.
	Please note that this tool relies on models that <strong>do not</strong> have a 100% accuracy rate.
      </p>
      <h2>How to Use the Tool</h2>
      <p style="margin-bottom: 0;">
        1. Enter a <strong>claim or text</strong> to be investigated in the input box.<br>
        2. Choose a mode:
      </p>  
      <ul style="margin:0;">
        <li><strong>Find First Related Tweet</strong> retrieves the earliest tweet supporting the claim.</li>
        <li><strong>Find All Related Tweets</strong> shows a dashboard of all related tweets and their activity.</li>
      </ul>
      <p style="margin-top:0;">
        3. Optionally configure a date range as well as further parameters in <strong>Advanced Settings</strong>.<br>
        4. Enable <strong>‚ÄúUse Synonyms‚Äù</strong> if you would like broader search coverage. During processing (if selected), you will be prompted to select synonyms for your claim, or provide your own.<br>
        5. Click <strong>Analyze</strong> to begin ‚Äî results will appear below or shown in the dashboard depending on your selected <strong>mode</strong>.<br>
      </p>
      <h2>Optional Parameter Information</h2>
      <ul>
        <li><strong>Initial date and final date</strong> - The time span to search through.</li>
        <li><strong>Max keywords</strong> - The maximum number of keywords extracted from the claim.</li>
        <li><strong>Number of keywords dropped</strong> - The number of keywords removed when generating query combinations.</li>
        <li><strong>Use Synonyms</strong> - Enables synonym expansion.</li>
        <li><strong>Model</strong> - The language model used for synonym extraction.</li>
        <li><strong>Top N Synonyms</strong> - The number of top similar words to consider as synonyms for each keyword.</li>
        <li><strong>Similarity Threshold</strong> - The minimum similarity score for a word to be considered a synonym.</li>
        <li><strong>Earliest k</strong> - The number of earliest tweets to retrieve, regardless of alignment with the claim.</li>
        <li><strong>Excludes</strong> - filters to exclude (e.g., to skip retweets or replies).</li>
      </ul>
      <!-- <p> -->
        For more information on the tool, please check out the <a href="https://github.com/vincentvvliet/climate-disinformation-detector/tree/master/frontend">documentation</a>.
      <!-- </p> -->
    </div>
  </div>

  <div class="container">
    <div id="info-icon" title="How to use the tool">
      <span>
        <img src="static/assets/info_icon.png"></img>
      </span>
    </div>
    <h2>Climate Disinformation Tracker</h2>

    <form id="detectForm">
      <input type="text" id="textInput" placeholder="Enter text to analyze..." required>

      <div class="date-inputs">
        <div>
          <label for="initialDate">Initial Date:</label>
          <input type="date" id="initialDate" name="initialDate">
        </div>
        <div>
          <label for="finalDate">Final Date:</label>
          <input type="date" id="finalDate" name="finalDate">
        </div>
      </div>

      <div class="mode-selection">
        <div>
          <input type="radio" id="find_source" name="mode" value="find_source" checked>
          <label for="find_source">Find First Related Tweet</label>
        </div>
        <div>
          <input type="radio" id="find_all" name="mode" value="find_all">
          <label for="find_all">Find All Related Tweets</label>
        </div>
      </div>

      <div class="advanced-settings">
        <button type="button" id="toggleAdvanced" class="toggle-btn">
          ‚öôÔ∏è Advanced Settings <span id="arrow">‚ñº</span>
        </button>
        <div id="advancedContent" class="advanced-content">
          <label id="use-synonyms-label" style="margin-bottom: -2.5rem;">
            <input type="checkbox" id="use-synonyms" name="synonyms"> Use Synonyms
          </label>

          <div id="synonym-options">
            <div>
              <label for="model_name">Model:</label>
              <select id="model_name" name="model_name">
                <option value="en_core_web_md" selected>en_core_web_md</option>
                <option value="en_core_web_lg">en_core_web_lg</option>
              </select>
            </div>
            
            <div>
              <label for="top_n_syns">Top N Synonyms:</label>
              <input type="number" id="top_n_syns" value="4" min="1" max="10">
            </div>
            
            <div>
              <label for="threshold">Similarity Threshold:</label>
              <input type="number" id="threshold" value="0.1" step="0.05" min="0" max="1">
            </div>
            
            <div>
              <label for="max_syns_per_kw">Max Synonyms per Keyword:</label>
              <input type="number" id="max_syns_per_kw" value="2" min="1" max="10">
            </div>
          </div>

          <div class="basic-settings">
            <div>
              <label for="max_keywords">Max Keywords</label>
              <input type="number" id="max_keywords" value="5">
            </div>            

            <div>
              <label for="n_keywords_dropped">Number of Keywords Dropped</label>
              <input type="number" id="n_keywords_dropped" value="1">
            </div>

            <div style="display: flex;flex-direction: column;">
              <label for="earliest_k">Earliest K Tweets</label>
              <input type="number" id="earliest_k" value="0">
            </div>
          </div>

          <div class="excludes-section">
            <label>Excludes</label>
            <div id="excludes" class="checkbox-group">
              <label><input type="checkbox" value="nativeretweets" checked> nativeretweets</label>
              <label><input type="checkbox" value="media"> media</label>
              <label><input type="checkbox" value="videos"> videos</label>
              <label><input type="checkbox" value="news"> news</label>
              <label><input type="checkbox" value="verified"> verified</label>
              <label><input type="checkbox" value="native_video"> native_video</label>
              <label><input type="checkbox" value="replies" checked> replies</label>
              <label><input type="checkbox" value="links"> links</label>
              <label><input type="checkbox" value="images"> images</label>
              <label><input type="checkbox" value="safe"> safe</label>
              <label><input type="checkbox" value="quote"> quote</label>
              <label><input type="checkbox" value="pro_video"> pro_video</label>
            </div>
          </div>
        </div>
      </div>

      <div style="display: flex; justify-content: center; align-items: center;">
        <button type="submit" id="analyzeBtn">Analyze</button>
      </div>
    </form>

    <!-- Dynamic synonym section -->
    <div id="synonymSection">
      <h3>Select Synonyms</h3>
      <div id="synonymList"></div>
      <button id="continueBtn" type="button">Continue</button>
    </div>

    <div id="result"></div>
  </div>

  <script>
    const resultDiv = document.getElementById('result');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const synonymSection = document.getElementById('synonymSection');
    const synonymList = document.getElementById('synonymList');

    document.getElementById('toggleAdvanced').addEventListener('click', () => {
      const advancedContent = document.getElementById('advancedContent');
      advancedContent.classList.toggle('show');
      document.getElementById('arrow').style.transform = advancedContent.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
    });

    document.getElementById('use-synonyms').addEventListener('change', (e) => {
      const synonymOptions = document.getElementById('synonym-options');
      synonymOptions.classList.toggle('show');
      document.getElementById('use-synonyms-label').style.marginBottom = e.target.checked ? '0' : '-2.5rem';
    });

    document.querySelectorAll('input[name="mode"]').forEach((e) => {
      e.addEventListener('click', function() {
        document.getElementById('earliest_k').parentElement.style.display = (this.value === 'find_source') ? 'flex' : 'none';
      });
    });
    
    // Info overlay functionality
    const infoOverlay = document.getElementById('info-overlay');

    document.getElementById('info-icon').addEventListener('click', () => {
      infoOverlay.classList.add('show');
    });

    document.getElementById('close-info').addEventListener('click', () => {
      infoOverlay.classList.remove('show');
    });

    infoOverlay.addEventListener('click', (e) => {
      // Close if clicked outside the content box
      if (e.target === infoOverlay) {
        infoOverlay.classList.remove('show');
      }
    });


    let cachedParams = {};
    let cachedSynonyms = {};
    let cachedKeywords = null;

    document.getElementById('detectForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      // resultDiv.style.display = 'flex';
      resultDiv.classList.add('show');
      resultDiv.innerHTML = '<div class="spinner_container"><div class="spinner"></div> Running analysis...</div>';
      analyzeBtn.disabled = true;

      const params = {
        text: document.getElementById('textInput').value,
        initial_date: document.getElementById('initialDate').value || "",
        final_date: document.getElementById('finalDate').value || "",
        mode: document.querySelector('input[name="mode"]:checked').value,
        max_keywords: parseInt(document.getElementById('max_keywords').value) || 5,
        n_keywords_dropped: parseInt(document.getElementById('n_keywords_dropped').value) || 1,
        excludes: Array.from(document.querySelectorAll('#excludes input:checked')).map(cb => cb.value),
        synonyms: document.getElementById('use-synonyms').checked,
        model_name: document.getElementById('model_name').value,
        top_n_syns: parseInt(document.getElementById('top_n_syns').value),
        threshold: parseFloat(document.getElementById('threshold').value),
        max_syns_per_kw: parseInt(document.getElementById('max_syns_per_kw').value),
        earliest_k: parseInt(document.getElementById('earliest_k').value)
      };

      cachedParams = params;

      try {
        if (params.synonyms) {
          const res = await fetch('http://127.0.0.1:8000/api/synonyms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              text: params.text,
              model_name: params.model_name,
              top_n_syns: params.top_n_syns,
              threshold: params.threshold
            })
          });
          const data = await res.json();
          cachedSynonyms = data.synonyms;
          cachedKeywords = data.keywords;
          displaySynonymOptions(cachedSynonyms);
        } else {
          await performAnalysis(params);
        }
      } catch (err) {
        resultDiv.textContent = 'Network error.';
      }
    });

    function displaySynonymOptions(synonyms) {
      synonymList.innerHTML = '';
      // synonymSection.style.display = 'block';
      synonymSection.classList.add('show');
      // resultDiv.style.display = 'none';
      resultDiv.classList.remove('show');

      for (const [kw, syns] of Object.entries(synonyms)) {
        const block = document.createElement('div');
        block.classList.add('keyword-block');
        block.innerHTML = `
          <h4>${kw}</h4>
          <div class="synonyms">
            ${syns.map(s => `
              <label><input type="checkbox" name="${kw}" value="${s}"> ${s}</label>
            `).join('')}
            ${syns.length === 0 ? '<em>No synonyms found</em>' : ''}
            <div class="custom-synonym-list"></div>
          </div>
          <div class="custom-synonym-input-area">
            <input type="text" placeholder="Add your own synonym...">
            <button type="button" class="add-synonym-btn">Add</button>
          </div>
        `;
        synonymList.appendChild(block);

        const input = block.querySelector('input[type="text"]');
        const addBtn = block.querySelector('.add-synonym-btn');
        const customList = block.querySelector('.custom-synonym-list');

        // Helper function for adding tags (used by Enter and Add button)
        const addTag = () => {
          const val = input.value.trim();
          if (!val) return;
          const tag = document.createElement('div');
          tag.classList.add('custom-synonym-tag', 'tag-appear');
          tag.innerHTML = `${val} <span>&times;</span>`;
          tag.querySelector('span').addEventListener('click', () => {
            tag.classList.add('tag-remove');
            setTimeout(() => tag.remove(), 300);
          });
          customList.appendChild(tag);
          input.value = '';
        };

        // Handle keyboard input
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addTag();
          } else if (e.key === 'Backspace' && input.value === '') {
            const last = customList.lastElementChild;
            if (last) {
              last.classList.add('tag-remove');
              setTimeout(() => last.remove(), 300);
            }
          }
        });

        // Handle button click
        addBtn.addEventListener('click', addTag);
      }
    }


    document.getElementById('continueBtn').addEventListener('click', async () => {
      const selections = {};
      document.querySelectorAll('.keyword-block').forEach(block => {
        const kw = block.querySelector('h4').textContent;
        const checked = [...block.querySelectorAll('input[type="checkbox"]:checked')].map(i => i.value);
        const custom = [...block.querySelectorAll('.custom-synonym-tag')].map(t => t.textContent.replace('√ó', '').trim());
        selections[kw] = [kw, ...checked, ...custom];
      });

      cachedParams["selected_synonyms"] = selections;
      cachedParams["keywords"] = cachedKeywords;
      // synonymSection.style.display = 'none';
      synonymSection.classList.remove('show');
      await performAnalysis(cachedParams);
    });

    async function performAnalysis(params) {
      // resultDiv.style.display = 'flex';
      resultDiv.classList.add('show');
      resultDiv.innerHTML = '<div class="spinner_container"><div class="spinner"></div> Running analysis...</div>';

      const response = await fetch('http://127.0.0.1:8000/api/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(params)
      });

      if (response.ok) {
        const result = await response.json();
        
        if (params.mode === 'find_source') {
          const data = result[0];
          const earliest_batch = result[1];
          resultDiv.innerHTML = `
            <h3>First Related Tweet Found:</h3>
            <div class="result-card">
              <p><strong>User:</strong> ${data.user}</p>
              <p><strong>Text:</strong> ${data.text}</p>
              <p><strong>Date:</strong> ${new Date(data.created_at_datetime).toLocaleString()}</p>
              <p><strong>Engagement:</strong> üëç ${data.likes} | üîÅ ${data.retweets} | üí¨ ${data.comments} | üîó ${data.quotes}</p>
              <p><a href="https://twitter.com${data.link}" target="_blank">View on Twitter</a></p>
            </div>
          `;
          analyzeBtn.disabled = false;

          // If earliest_batch is available, show it
          if (earliest_batch && earliest_batch.length > 0) {
            const earliestDiv = document.createElement('div');
            earliestDiv.innerHTML = '<h3 style="text-align: center;">Earliest ' + params.earliest_k + ' Tweets:</h3>';
            earliest_batch.forEach(tweet => {
              const tweetDiv = document.createElement('div');
              tweetDiv.classList.add('result-card');
              tweetDiv.innerHTML = `
                <p><strong>User:</strong> ${tweet.user}</p>
                <p><strong>Text:</strong> ${tweet.text}</p>
                <p><strong>Date:</strong> ${new Date(tweet.created_at_datetime).toLocaleString()}</p>
                <p><strong>Engagement:</strong> üëç ${tweet.likes } | üîÅ ${tweet.retweets} | üí¨ ${tweet.comments} | üîó ${tweet.quotes}</p>
                <p><a href="https://twitter.com${tweet.link}" target="_blank">View on Twitter</a></p>
              `;
              earliestDiv.appendChild(tweetDiv);
            });
            resultDiv.appendChild(earliestDiv);
          }
        } else if (params.mode === 'find_all') {
          const dashboardResponse = await fetch('/api/visualization', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: result, claim: params.text })
          });
          const dashboardData = await dashboardResponse.json();
          if (dashboardData.redirect_url) {
            window.location.href = dashboardData.redirect_url;
          }
        }
      } else {
        resultDiv.textContent = 'Error analyzing text.';
      }
      analyzeBtn.disabled = false;
    }
  </script>
</body>
</html>
